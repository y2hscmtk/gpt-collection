const h="gptBookmarks",w="gptBookmarkContent:";function T(){return typeof chrome<"u"&&chrome?.storage?.sync?chrome.storage.sync:chrome.storage?.local??null}function y(){return typeof chrome<"u"&&chrome?.storage?.local?chrome.storage.local:null}function A(t,n,...e){return new Promise((r,o)=>{if(!t?.[n]){r();return}t[n](...e,c=>{const s=chrome.runtime?.lastError;if(s){o(new Error(s.message));return}r(c)})})}const i={SYNC_KEY:h,CONTENT_PREFIX:w,LOCAL_CONTENT_MAX_BYTES:2097152,getSyncArea:T,getLocalArea:y,promisify:A},C=120;function v(t){return t?Array.isArray(t)?t:[]:[]}function f(t,...n){const e=[typeof t=="string"?t:null,...n];for(const r of e){if(typeof r!="string")continue;const o=r.trim();if(o.length===0)continue;const c=o.split(`
`).map(s=>s.trim()).find(s=>s.length>0)??o;if(c.length>0)return c.slice(0,C)}return"제목 없음"}function g(t){return v(t).filter(n=>n&&typeof n=="object").map(n=>({...n,savedAt:n.savedAt??Date.now(),snippet:n.snippet??"",title:f(n.title,n.snippet??"",n.conversationTitle??""),conversationTitle:n.conversationTitle??"ChatGPT",projectId:n.projectId??null,projectTitle:n.projectTitle??null,origin:n.origin??null,messageId:n.messageId??n.id})).sort((n,e)=>(e.savedAt??0)-(n.savedAt??0))}async function d(){const t=i.getSyncArea();try{const e=(await i.promisify(t,"get",i.SYNC_KEY))?.[i.SYNC_KEY];return g(e)}catch(n){return console.warn("[gpt-bookmarks] chrome.storage.sync.get failed:",n),[]}}async function p(t){const n=i.getSyncArea();await i.promisify(n,"set",{[i.SYNC_KEY]:t})}function u(t){return`${i.CONTENT_PREFIX}${t}`}async function E(t,n){if(typeof n!="string"||n.length===0)return!1;const e=i.getLocalArea();if(!e)return!1;const r=n.length>i.LOCAL_CONTENT_MAX_BYTES?n.slice(0,i.LOCAL_CONTENT_MAX_BYTES):n,o={[u(t)]:{content:r,updatedAt:Date.now()}};return await i.promisify(e,"set",o),!!o[u(t)].content}async function m(t){if(!t)return;const n=i.getLocalArea();n&&await i.promisify(n,"remove",u(t)).catch(e=>{console.warn("[gpt-bookmarks] remove content failed:",e)})}async function _(t){if(!t)throw new Error("Bookmark payload is required");const n=await d(),e=t.messageId||t.id||crypto.randomUUID(),r=t.messageId??e,o={id:e,messageId:r,conversationId:t.conversationId??null,conversationTitle:t.conversationTitle??"ChatGPT",projectId:t.projectId??null,projectTitle:t.projectTitle??null,origin:t.origin??null,snippet:(t.snippet??"").slice(0,160),title:f(t.title,t.content??"",t.snippet??"",t.conversationTitle??""),url:t.url,savedAt:t.savedAt??Date.now(),hasContent:!1};t.content&&(o.hasContent=await E(e,t.content));const c=[...n.filter(s=>s.id!==e),o].sort((s,a)=>(a.savedAt??0)-(s.savedAt??0));try{await p(c)}catch(s){throw await m(e),s}return o}async function N(t){if(!t)return;const e=(await d()).filter(r=>r.id!==t);await p(e),await m(t)}async function B(t,n){if(!t)throw new Error("Bookmark id is required");if(!n||typeof n!="object")return null;const e=await d(),r=e.findIndex(a=>a.id===t);if(r===-1)return null;const o=e[r],c={...o,...n};"title"in n&&(c.title=f(n.title,n.snippet??o.snippet,o.conversationTitle));const s=e.map((a,l)=>l===r?c:a).sort((a,l)=>(l.savedAt??0)-(a.savedAt??0));return await p(s),c}function L(t){if(typeof chrome>"u"||!chrome.storage?.onChanged)return()=>{};const n=(e,r)=>{if(r!=="sync"||!e?.[i.SYNC_KEY])return;const o=g(e[i.SYNC_KEY].newValue);t(o)};return chrome.storage.onChanged.addListener(n),()=>{chrome.storage.onChanged.removeListener(n)}}function Y({origin:t,projectId:n,conversationId:e}){const r=t||(typeof window<"u"?window.location.origin:"https://chatgpt.com"),o=[];return n&&o.push("p",n),e&&o.push("c",e),o.length===0?typeof window<"u"?window.location.href:r:`${r}/${o.join("/")}`}export{_ as a,Y as b,d as l,N as r,L as s,B as u};
